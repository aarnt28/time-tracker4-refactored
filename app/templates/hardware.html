<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hardware</title>
  <link rel="stylesheet" href="/static/app.css" />
  <link rel="icon" href="/static/favicon.ico" />
</head>
<body class="dashboard">
  <header class="app-header">
    <div class="container">
      <h1>Hardware</h1>
      <div class="actions">
        <button class="btn" type="button" id="new-hardware">New Hardware</button>
      </div>
      <nav class="links">
        <a href="/" class="pill">Dashboard</a>
        <a href="/tickets" class="pill">Tickets</a>
        <a href="/hardware" class="pill active" aria-current="page">Hardware</a>
        <a href="/clients" class="pill">Clients</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="table-wrap">
      <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th class="mono">Barcode</th>
              <th>Description</th>
              <th class="mono">Acquisition Cost</th>
              <th class="mono">Sales Price</th>
              <th class="mono">Created</th>
              <th class="th-action">Actions</th>
            </tr>
          </thead>
          <tbody id="hardware-rows">
            {% include "_hardware_rows.html" with context %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="hardware-modal" class="modal-root" style="display:none;">
    <div class="modal-card modal-card--medium">
      <header class="modal-head">
        <h2 id="hardware-modal-title" class="modal-title">New Hardware</h2>
        <button id="hardware-modal-close" class="btn" type="button">Close</button>
      </header>
      <form id="hardware-form" class="modal-form">
        <input type="hidden" name="id" />
        <div class="form-grid two-column">
          <label>Barcode<input name="barcode" required class="mono" /></label>
          <label>Description<input name="description" required /></label>
          <label>Acquisition Cost<input name="acquisition_cost" class="mono" /></label>
          <label>Sales Price<input name="sales_price" class="mono" /></label>
        </div>
        <div class="form-actions">
          <button class="btn" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  (function(){
    function getApiToken(){ return window.localStorage.getItem('api_token') || ''; }
    function setApiToken(t){ if (t) window.localStorage.setItem('api_token', t); }
    function apiHeaders(json=true){
      const h = {};
      if (json) h['Content-Type'] = 'application/json';
      const t = getApiToken();
      if (t) h['X-API-Key'] = t;
      return h;
    }
    async function safeFetch(url, opts={}, retry=true){
      const res = await fetch(url, opts);
      if (res.status === 401 && retry){
        const t = window.prompt('Enter API token');
        if (!t) return res;
        setApiToken(t);
        const newOpts = Object.assign({}, opts);
        newOpts.headers = Object.assign({}, opts.headers || {}, {'X-API-Key': t});
        return safeFetch(url, newOpts, false);
      }
      return res;
    }

    const modal = document.getElementById('hardware-modal');
    const title = document.getElementById('hardware-modal-title');
    const closeBtn = document.getElementById('hardware-modal-close');
    const form = document.getElementById('hardware-form');
    const btnNew = document.getElementById('new-hardware');
    const hardwareRows = document.getElementById('hardware-rows');

    function openModal(data){
      modal.style.display = 'block';
      form.reset();
      if (data){
        title.textContent = `Edit Hardware (${data.barcode})`;
        form.elements.id.value = data.id;
        form.elements.barcode.value = data.barcode || '';
        form.elements.description.value = data.description || '';
        form.elements.acquisition_cost.value = data.acquisition_cost || '';
        form.elements.sales_price.value = data.sales_price || '';
      } else {
        title.textContent = 'New Hardware';
        form.elements.id.value = '';
      }
      form.elements.barcode.focus();
    }

    function closeModal(){
      modal.style.display = 'none';
    }

    async function loadHardware(id){
      if (!id) return;
      try {
        const res = await safeFetch(`/api/v1/hardware/${id}`, { headers: apiHeaders(false) });
        if (!res.ok) throw new Error('failed hardware fetch');
        const data = await res.json();
        openModal(data);
      } catch (err) {
        window.alert('Failed to load hardware item');
      }
    }

    async function refreshHardwareRows(){
      if (!hardwareRows) return;
      try {
        const res = await fetch('/ui/hardware_table', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('refresh failed');
        const html = await res.text();
        hardwareRows.innerHTML = html;
      } catch (err) {
        console.error('hardware refresh failed', err);
        window.alert('Failed to refresh hardware list. Please reload the page.');
      }
    }

    closeBtn.addEventListener('click', closeModal);
    btnNew.addEventListener('click', function(){ openModal(null); });

    if (hardwareRows){
      hardwareRows.addEventListener('click', function(e){
        const row = e.target.closest('tr.row');
        if (!row) return;
        if (e.target.closest('button, input, textarea, select, label')) return;
        const link = e.target.closest('a.edit-hardware');
        if (link) e.preventDefault();
        const id = row.dataset.id;
        if (!id) return;
        loadHardware(id);
      });

      hardwareRows.addEventListener('submit', async function(e){
        const formEl = e.target.closest('form');
        if (!formEl || !formEl.classList.contains('inline')) return;
        e.preventDefault();
        const action = formEl.getAttribute('action') || formEl.action;
        try {
          const res = await fetch(action, { method: 'POST', credentials: 'same-origin' });
          if (!res.ok) throw new Error('delete failed');
          await refreshHardwareRows();
        } catch (err) {
          console.error('hardware delete failed', err);
          window.alert('Delete failed');
        }
      });
    }

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      const id = form.elements.id.value;
      const barcode = form.elements.barcode.value.trim();
      const description = form.elements.description.value.trim();
      if (!barcode || !description){
        window.alert('Barcode and Description are required.');
        return;
      }
      const payload = { barcode, description };
      const acqRaw = form.elements.acquisition_cost.value.trim();
      const saleRaw = form.elements.sales_price.value.trim();
      if (acqRaw || id) payload.acquisition_cost = acqRaw;
      if (saleRaw || id) payload.sales_price = saleRaw;

      const method = id ? 'PATCH' : 'POST';
      const url = id ? `/api/v1/hardware/${id}` : '/api/v1/hardware';
      const res = await safeFetch(url, {
        method,
        headers: apiHeaders(true),
        body: JSON.stringify(payload)
      });
      if (res.ok){
        closeModal();
        await refreshHardwareRows();
      } else {
        let msg = 'Save failed';
        try {
          const body = await res.json();
          if (body && body.detail) msg = `Save failed: ${body.detail}`;
        } catch (err) {
          /* ignore json parse errors */
        }
        window.alert(msg);
      }
    });
  })();
  </script>
</body>
</html>


