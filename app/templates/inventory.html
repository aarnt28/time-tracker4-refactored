<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory</title>
  <link rel="stylesheet" href="/static/app.css" />
  <link rel="icon" href="/static/favicon.ico" />
</head>
<body class="dashboard">
  <header class="app-header">
    <div class="container">
      <div class="branding">
        <img
          src="/static/img/vip-full-hd-transparant-cropped-halfsize.png"
          srcset="/static/img/vip-full-hd-transparant-cropped-halfsize.png 1x, /static/img/vip-full-hd-transparant-384x150.png 2x"
          alt="VIP Clouds logo"
          class="branding__logo"
        />
        <div class="branding__meta">
          <span class="branding__kicker">VIP Clouds</span>
          <h1 class="logo"><a href="/">Time Tracker</a></h1>
        </div>
      </div>
      <h2 class="page-title">Inventory</h2>
      <nav class="links">
        <a href="/" class="pill">Dashboard</a>
        <a href="/tickets" class="pill">Tickets</a>
        <a href="/hardware" class="pill">Hardware</a>
        <a href="/inventory" class="pill active" aria-current="page">Inventory</a>
        <a href="/clients" class="pill">Clients</a>
        <a href="/reports" class="pill">Reports</a>
      </nav>
    </div>
  </header>

  <main class="container inventory-layout">
    <section class="card">
      <header class="card__header">
        <h2 class="card__title">Current stock</h2>
      </header>
      <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th class="mono">Barcode</th>
              <th>Description</th>
              <th class="mono">On Hand</th>
              <th class="mono">Last Activity</th>
            </tr>
          </thead>
          <tbody id="inventory-summary-rows">
            {% include "_inventory_summary_rows.html" with context %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <header class="card__header">
        <h2 class="card__title">Adjust inventory</h2>
      </header>
      <form method="post" action="/inventory/adjust" class="inventory-form">
        <label class="inventory-form__field">
          <span>Hardware item</span>
          <select name="hardware_id" required>
            <option value="" disabled selected>Select hardware</option>
            {% for hardware in hardware_options %}
              <option value="{{ hardware.id }}">{{ hardware.description }} ({{ hardware.barcode }})</option>
            {% endfor %}
          </select>
        </label>
        <label class="inventory-form__field">
          <span>Action</span>
          <select name="action">
            <option value="receive">Receive stock</option>
            <option value="use">Use stock</option>
          </select>
        </label>
        <label class="inventory-form__field">
          <span>Quantity</span>
          <input name="quantity" type="number" min="1" value="1" required />
        </label>
        <label class="inventory-form__field">
          <span>Vendor (receive)</span>
          <input name="vendor_name" placeholder="Supplier name" />
        </label>
        <label class="inventory-form__field">
          <span>Client (use)</span>
          <input name="client_name" placeholder="Destination or client" />
        </label>
        <label class="inventory-form__field">
          <span>Acquisition cost (total)</span>
          <input name="actual_cost" type="number" step="0.01" min="0" placeholder="0.00" />
        </label>
        <label class="inventory-form__field">
          <span>Sale price (total)</span>
          <input name="sale_price" type="number" step="0.01" min="0" placeholder="0.00" />
        </label>
        <label class="inventory-form__field inventory-form__field--wide">
          <span>Note</span>
          <input name="note" />
        </label>
        <div class="inventory-form__actions">
          <button class="btn" type="submit">Save adjustment</button>
        </div>
      </form>
    </section>

    <section class="card">
      <header class="card__header">
        <h2 class="card__title">Recent activity</h2>
      </header>
      <div class="table-scroll">
        <table class="table">
          <thead>
            <tr>
              <th class="mono">When</th>
              <th>Item</th>
              <th class="mono">Change</th>
              <th>Source</th>
              <th>Note</th>
              <th>Counterparty</th>
              <th class="mono">Acquisition cost</th>
              <th class="mono">Sale price</th>
              <th class="mono">Margin</th>
              <th class="th-action">Actions</th>
            </tr>
          </thead>
          <tbody id="inventory-event-rows">
            {% include "_inventory_event_rows.html" with context %}
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
  (function(){
    const REFRESH_INTERVAL = 30000;
    const summaryRows = document.getElementById('inventory-summary-rows');
    const eventRows = document.getElementById('inventory-event-rows');
    const inventoryForm = document.querySelector('.inventory-form');

    async function fetchPartial(url){
      const res = await fetch(url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'fetch' } });
      if (!res.ok) throw new Error('Failed request');
      return res.text();
    }

    async function refreshSummary(){
      if (!summaryRows) return;
      try {
        const html = await fetchPartial('/ui/inventory_summary');
        summaryRows.innerHTML = html;
      } catch (err) {
        console.warn('inventory summary refresh failed', err);
      }
    }

    async function refreshEvents(){
      if (!eventRows) return;
      try {
        const html = await fetchPartial('/ui/inventory_events');
        eventRows.innerHTML = html;
      } catch (err) {
        console.warn('inventory events refresh failed', err);
      }
    }

    async function refreshAll(){
      await Promise.all([refreshSummary(), refreshEvents()]);
    }

    if (inventoryForm){
      const actionField = inventoryForm.querySelector('select[name="action"]');
      const quantityField = inventoryForm.querySelector('input[name="quantity"]');

      inventoryForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const form = e.currentTarget;
        const data = new FormData(form);
        const hardwareId = data.get('hardware_id');
        const action = (data.get('action') || 'receive').toLowerCase();
        const quantityRaw = data.get('quantity') || '0';
        const note = (data.get('note') || '').trim();
        const vendorName = (data.get('vendor_name') || '').trim();
        const clientName = (data.get('client_name') || '').trim();
        const actualCostRaw = (data.get('actual_cost') || '').trim();
        const salePriceRaw = (data.get('sale_price') || '').trim();

        if (!hardwareId){
          window.alert('Select a hardware item before saving.');
          return;
        }

        const quantity = Number.parseInt(quantityRaw, 10);
        if (!Number.isFinite(quantity) || quantity <= 0){
          window.alert('Quantity must be a positive integer.');
          return;
        }

        const payload = {
          hardware_id: Number.parseInt(hardwareId, 10),
          quantity,
          note: note || null,
          vendor_name: vendorName || null,
          client_name: clientName || null,
        };

        if (actualCostRaw){
          const costValue = Number.parseFloat(actualCostRaw);
          if (!Number.isFinite(costValue) || costValue < 0){
            window.alert('Actual cost must be a non-negative number.');
            return;
          }
          payload.actual_cost = costValue;
        }

        if (salePriceRaw){
          const saleValue = Number.parseFloat(salePriceRaw);
          if (!Number.isFinite(saleValue) || saleValue < 0){
            window.alert('Sale price must be a non-negative number.');
            return;
          }
          payload.sale_price = saleValue;
        }

        const endpoint = action === 'use' ? '/api/v1/inventory/use' : '/api/v1/inventory/receive';

        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'fetch',
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok){
            let message = 'Save failed';
            try {
              const body = await res.json();
              if (body && body.detail) message = Array.isArray(body.detail) ? body.detail.map(entry => entry.msg).join(', ') : body.detail;
            } catch (parseErr) {
              /* ignore parse errors */
            }
            window.alert(message);
            return;
          }

          form.reset();
          if (actionField) actionField.value = 'receive';
          if (quantityField) quantityField.value = '1';
          await refreshAll();
        } catch (err) {
          console.error('inventory adjustment failed', err);
          window.alert('Save failed');
        }
      });
    }

    if (eventRows){
      eventRows.addEventListener('submit', async function(e){
        const form = e.target.closest('form.inline');
        if (!form) return;
        e.preventDefault();
        try {
          const res = await fetch(form.action || form.getAttribute('action'), {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'fetch' },
          });
          if (!res.ok) throw new Error('delete failed');
          await refreshAll();
        } catch (err) {
          console.error('inventory delete failed', err);
          window.alert('Delete failed');
        }
      });
    }

    refreshAll();
    window.setInterval(refreshAll, REFRESH_INTERVAL);
    window.addEventListener('focus', refreshAll);
  })();
  </script>
</body>
</html>
